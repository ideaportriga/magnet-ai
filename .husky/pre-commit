#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Get the list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Check if there are any Python files in api/
API_FILES=$(echo "$STAGED_FILES" | grep "^api/.*\.py$" || true)

# Check if there are any JS/TS/Vue files in web/
WEB_FILES=$(echo "$STAGED_FILES" | grep "^web/.*\.\(js\|ts\|vue\)$" || true)

# Run ruff for API changes
if [ -n "$API_FILES" ]; then
  echo "üîç Running ruff for API..."
  cd api
  poetry run ruff check . --fix || exit 1
  cd ..
fi

# Run eslint for Web changes (only on changed files to avoid blocking on existing issues)
if [ -n "$WEB_FILES" ]; then
  echo "üîç Running eslint for Web (changed files only)..."
  cd web
  # Lint only the staged files
  WEB_FILES_RELATIVE=$(echo "$WEB_FILES" | sed 's|^web/||')
  echo "$WEB_FILES_RELATIVE" | xargs yarn eslint --fix --max-warnings 0
  ESLINT_EXIT=$?
  
  # Re-add fixed files to staging
  if [ $ESLINT_EXIT -eq 0 ]; then
    echo "$WEB_FILES_RELATIVE" | xargs git add
  else
    echo "‚ùå ESLint found issues. Please fix them and try again."
    exit 1
  fi
  cd ..
fi

echo "‚úÖ Pre-commit checks passed!"
